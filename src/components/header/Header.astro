---
import { Mountain } from '@lucide/astro'
import { getLang, getTranslations } from '@utils/i18'
import { getCartCount } from '@utils/cart'
import { MobileMenu } from './MobileMenu'
import { MobileMenuButton } from './MobileMenuButton'
import LangSwitcher from './LangSwitcher.astro'
import ThemeSwitcher from './ThemeSwitcher.astro'
import CartButton from './CartButton'

const lang = getLang(Astro.params)
const { header } = getTranslations(Astro.params)
const { subtitle, title, products, mission, impact } = header
const cart = await Astro.session?.get('cart')
---

<header
  role="banner"
  class="bg-white dark:bg-stone-900 border-stone-200 dark:border-stone-700 shadow-sm border-b sticky top-0 z-40 transition-colors"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <a href={`/${lang}`} class="flex items-center space-x-3">
        <Mountain class="h-8 w-8 text-amber-600" />
        <div>
          <h1 class="text-xl font-bold text-stone-900 dark:text-white">
            {title}
          </h1>
          <p class="text-xs text-stone-600 dark:text-stone-400 -mt-1">
            {subtitle}
          </p>
        </div>
      </a>

      <nav
        class="hidden md:flex items-center space-x-8"
        role="navigation"
        aria-label="Main navigation"
      >
        <a
          data-hash-link
          href="#products"
          class="text-stone-700 dark:text-stone-300 hover:text-amber-600 dark:hover:text-amber-400 transition-colors font-medium"
        >
          {products}
        </a>
        <a
          data-hash-link
          href="#mission"
          class="text-stone-700 dark:text-stone-300 hover:text-amber-600 dark:hover:text-amber-400 transition-colors font-medium"
        >
          {mission}
        </a>
        <a
          data-hash-link
          href="#impact"
          class="text-stone-700 dark:text-stone-300 hover:text-amber-600 dark:hover:text-amber-400 transition-colors font-medium"
        >
          {impact}
        </a>
        <div class="block">
          <CartButton
            client:load
            title={header.cart}
            initialCartCount={getCartCount(cart)}
          />
        </div>
        <LangSwitcher />
        <ThemeSwitcher />
      </nav>

      <MobileMenuButton client:load />
    </div>
    <MobileMenu
      menuItems={[
        { href: '#products', title: products },
        { href: '#mission', title: mission },
        { href: '#impact', title: impact },
      ]}
      client:load
    />
  </div>
</header>

<script>
  document.addEventListener('click', (e) => {
    const hashLink = (e.target as HTMLLinkElement)
      .closest('[data-hash-link]')
      ?.getAttribute('href')
    if (hashLink) {
      const langSwitcher = document.querySelector(
        '[data-lang-switcher]'
      ) as HTMLLinkElement
      const { lang } = langSwitcher.dataset
      const { nextLang } = langSwitcher.dataset
      if (lang && nextLang && langSwitcher) {
        langSwitcher.href = `${window.location.pathname.replace(lang, nextLang)}${hashLink}`
      }
    }
  })
</script>
