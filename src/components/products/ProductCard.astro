---
import { getTranslations } from '../../../lib/i18/getTranslations'
import type { Product } from '../../types'
import { Package, Plus } from '@lucide/astro'

interface Props {
  product: Product
}

const { product } = Astro.props
const { products } = getTranslations(Astro.params.lang)
---

<article
  class="bg-white dark:bg-stone-700 border-stone-200 dark:border-stone-600 rounded-lg shadow-sm border overflow-hidden hover:shadow-md transition-all"
  itemscope
  itemtype="https://schema.org/Product"
>
  <div class="relative">
    <img
      src={product.image}
      alt={product.name}
      loading="lazy"
      width={500}
      height={300}
      class="w-full h-48 object-cover"
      itemprop="image"
    />
    <div class="absolute top-3 right-3">
      <span
        class="bg-white/90 dark:bg-stone-800/90 text-stone-700 dark:text-stone-300 backdrop-blur-sm px-2 py-1 rounded-md text-xs font-medium"
      >
        {product.category === 'chalk' ? 'Chalk' : 'Apparel'}
      </span>
    </div>
  </div>

  <div class="p-6">
    <h3
      class="text-lg font-semibold text-stone-900 dark:text-white mb-2"
      itemprop="name"
    >
      {product.name}
    </h3>
    <p
      class="text-stone-600 dark:text-stone-300 text-sm mb-4 leading-relaxed"
      itemprop="description"
    >
      {product.description}
    </p>

    <div class="mb-4">
      <h4
        class="text-xs font-medium text-stone-700 dark:text-stone-300 mb-2 flex items-center"
      >
        <Package class="h-3 w-3 mr-1" />
      </h4>
      <ul class="text-xs text-stone-600 dark:text-stone-400 space-y-1">
        {
          product.features.map((feature) => (
            <li class="flex items-center">
              <span class="w-1 h-1 bg-amber-500 dark:bg-amber-400 rounded-full mr-2 flex-shrink-0" />
              {feature}
            </li>
          ))
        }
      </ul>
    </div>

    <div class="flex items-center justify-between">
      <span
        class="text-2xl font-bold text-stone-900 dark:text-white"
        itemprop="price"
      >
        ${product.price}
        <meta itemprop="priceCurrency" content="USD" />
      </span>
      <button
        data-productid={product.id}
        aria-label={`Add ${product.name} to cart`}
        class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2"
        data-add-to-cart
      >
        <Plus class="h-4 w-4" />
        <span>{products.addToCart}</span>
      </button>
    </div>
  </div>
</article>

<script>
  import { actions } from 'astro:actions'
  import { getCartCount } from '../../utils/cart'
  import { getProducts } from '../../data/products'

  // Use a global event listener since language changes re-render the entire HTML,
  // invalidating previously stored DOM references.
  document.addEventListener('click', async ({ target }) => {
    const addToCartButton = (target as HTMLElement).closest<HTMLButtonElement>(
      '[data-add-to-cart]'
    )
    if (addToCartButton) {
      const { productid } = addToCartButton.dataset
      if (productid) {
        const { data } = await actions.addToCart({ productId: productid })
        const cartItemsCount = getCartCount(data)
        const cartCounter = document?.querySelector('[cart-counter]')
        const cartBtn = document?.querySelector('[cart-button]')
        console.log(cartBtn)

        cartBtn?.setAttribute(
          'aria-label',
          `Shopping cart with ${cartItemsCount} ${cartItemsCount === 1 ? 'item' : 'items'}`
        )
        if (cartCounter) {
          cartCounter.textContent = String(cartItemsCount)
        }
      }
    }
  })

  // Use a global event listener since language changes re-render the entire HTML,
  // invalidating previously stored DOM references.
  document.addEventListener('click', async ({ target }) => {
    const lang = document.documentElement.lang || 'en'
    const res = await fetch(`/locales/${lang}/translations.json`)
    const translations = await res.json()
    const addToCartButton = (target as HTMLElement).closest<HTMLButtonElement>(
      '[data-add-to-cart]'
    )
    if (addToCartButton) {
      const { productid } = addToCartButton.dataset
      if (productid) {
        const product = getProducts(translations).find(
          (product) => product.id === productid
        )
        const cartNotification = document.querySelector<HTMLElement>(
          '[data-cart-notification]'
        )
        const timeoutId = cartNotification?.dataset.timeoutId
        clearTimeout(timeoutId)
        cartNotification?.classList.remove('hidden')
        cartNotification?.classList.add('block')
        const cartNotificationImage =
          cartNotification?.querySelector<HTMLImageElement>(
            '[data-cart-notification-image]'
          )
        const cartNotificationProductName = cartNotification?.querySelector(
          '[data-cart-notification-product-name]'
        )
        const cartNotificationProductPrice = cartNotification?.querySelector(
          '[data-cart-notification-product-price]'
        )

        if (cartNotificationImage) {
          cartNotificationImage.src = product?.image ?? ''
          cartNotificationImage.alt = product?.name ?? ''
        }

        if (cartNotificationProductName) {
          cartNotificationProductName.textContent = product?.name ?? ''
        }

        if (cartNotificationProductPrice) {
          cartNotificationProductPrice.textContent = String(product?.price)
        }

        const id = setTimeout(async () => {
          cartNotification?.classList.remove('block')
          cartNotification?.classList.add('hidden')
        }, 5000)

        if (cartNotification) {
          cartNotification.dataset.timeoutId = String(id)
        }
      }
    }
  })
</script>
